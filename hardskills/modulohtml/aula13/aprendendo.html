<!DOCTYPE html>
<html>
    <head>
        <title>Aprendendo Canvas</title>
        <style>
            canvas {border:solid black 1px}
        </style>
        <script src="gosprite.js">

        </script>
        <script src="rpgobjetos.js">
            
        </script>
    </head>
    <body>
        <canvas id="canvas" width="600" height="600"></canvas>
        <script type="text/javascript">
            var LEFT = 37, UP = 38, RIGHT = 39, DOWN = 40;
            var mvLeft = mvUp = mvRight = mvDown = false;

            var canvas = document.querySelector("canvas");
            var ctx = canvas.getContext("2d");
            var jogador = 0;
            var gameObjetos = [
                new DynamicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 1), 0, 0, 50, 0),
                new DynamicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 5), 250, 50, 50, 270), 
                new DynamicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 5), 50, 250, 50, 0),
                new DynamicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 6), 50, 50, 50, 90),
                //new PhysicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 6), 50, 50, 50, 90),
                new DynamicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 3), -250, 50, 50, 0),
                new DynamicObjeto(new GOSprite(32, 32, "sprites/ships_packed.png", 7), -50, 50, 50, 0)
            ];
            var iaTargets = [
                
            ]
            window.addEventListener("keydown", keyDownHandler, false)
            window.addEventListener("keyup", keyUpHandler, false)

            function updateIAControls()
            {
                for(i = 0; i < gameObjetos.length; i++){
                    
                    if(i == jogador || !(gameObjetos[i] instanceof DynamicObjeto)){
                        if(iaTargets.length <= i){
                        iaTargets.push(null);
                        }
                        continue;
                    }

                    let gameObjeto = gameObjetos[i];
                    let tgt;
                    if(iaTargets.length <= i){
                        tgt = new Objeto ((Math.random()-.5)*canvas.width, (Math.random()-.5)*canvas.height);
                        iaTargets.push(tgt);
                        console.log(i + " add " + tgt);
                    } else {
                        tgt = iaTargets[i];
                    }

                    let dirX = gameObjeto.positionX - tgt.positionX;
                    let dirY = gameObjeto.positionY - tgt.positionY;
                    gameObjeto.directionX = dirX/dirX;
                    gameObjeto.directionY = dirY/dirY;
                    //
                }
            }

            function updatePlayerControls(){
                let gameObjeto = gameObjetos[jogador];
                if(mvLeft){
                    gameObjeto.directionX = -1;
                } else
                if(mvRight){
                    gameObjeto.directionX = +1;
                } else {
                    gameObjeto.directionX = 0;
                }
                if(mvUp){
                    gameObjeto.directionY = 1;
                } else
                if(mvDown){
                    gameObjeto.directionY = -1;
                } else {
                    gameObjeto.directionY = 0;
                }
            }

            function keyUpHandler (e){
                let key = e.keyCode;
                if(key == LEFT) mvLeft = false;
                if(key == RIGHT) mvRight = false;
                if(key == UP) mvUp = false;
                if(key == DOWN) mvDown = false;

            }

            function keyDownHandler (e){
                let key = e.keyCode;
                if(key == LEFT) mvLeft = true;
                if(key == RIGHT) mvRight = true;
                if(key == UP) mvUp = true;
                if(key == DOWN) mvDown = true;

            }
   
            function gameupdate (){
                for(i = 0; i < gameObjetos.length; i++){
                    let gameObjeto = gameObjetos[i];
                    
                    if(gameObjeto instanceof DynamicObjeto){
                        gameObjeto.update();
                    }

                    if(gameObjeto instanceof PhysicObjeto){
                        for(j = 0; j < gameObjetos.length; j++)
                        {
                            if(i == j) continue;
                            gameObjeto.collision(gameObjetos[j]);
                        }
                    }
                }
            }

            function gamedraw (){
                this.ctx.clearRect(0,0, canvas.width, canvas.height);
                for(i = 0; i < gameObjetos.length; i++){
                    gameObjetos[i].draw(canvas, ctx);
                }
            }

            function gameloop (){
                
                window.requestAnimationFrame(gameloop, canvas);
                updatePlayerControls();
                updateIAControls();
                gameupdate();
                gamedraw();
            }

            gameloop ();
        </script>
    </body>
</html>